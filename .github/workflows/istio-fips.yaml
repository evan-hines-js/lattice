name: Build Istio FIPS

on:
  push:
    branches: [main]
    paths:
      - '.github/workflows/istio-fips.yaml'
  workflow_dispatch:
    inputs:
      istio_version:
        description: 'Istio version to build'
        required: true
        default: '1.24.2'
  schedule:
    # Rebuild weekly to pick up security patches
    - cron: '0 0 * * 0'

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: evan-hines-js/istio-fips
  ISTIO_VERSION: ${{ github.event.inputs.istio_version || '1.24.2' }}

jobs:
  build-istiod:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Istio
        uses: actions/checkout@v4
        with:
          repository: istio/istio
          ref: ${{ env.ISTIO_VERSION }}

      - name: Set up Go 1.24
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Build pilot-discovery (istiod) with Go 1.24 FIPS
      - name: Build istiod binary
        env:
          GOFIPS140: latest
          CGO_ENABLED: 0
          GOOS: linux
        run: |
          mkdir -p out/linux_amd64 out/linux_arm64
          GOARCH=amd64 go build -o out/linux_amd64/pilot-discovery ./pilot/cmd/pilot-discovery
          GOARCH=arm64 go build -o out/linux_arm64/pilot-discovery ./pilot/cmd/pilot-discovery

      - name: Build and push istiod image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: pilot/docker/Dockerfile.pilot
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/pilot:${{ env.ISTIO_VERSION }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/pilot:latest
          build-args: |
            TARGETARCH=amd64

  build-proxyv2:
    # Envoy FIPS build requirements:
    # - 32GB+ RAM (2GB per core)
    # - 100GB+ disk space
    # - Docker installed
    # - 60-120 minutes build time
    #
    # Self-hosted runner setup:
    #   1. Install runner: https://github.com/evan-hines-js/lattice/settings/actions/runners/new
    #   2. Add labels: self-hosted, linux, x64, high-memory
    #   3. Ensure Docker is installed and runner user is in docker group
    runs-on: [self-hosted, linux, x64, high-memory]
    timeout-minutes: 180
    permissions:
      contents: read
      packages: write

    env:
      ENVOY_VERSION: "1.32.2"

    steps:
      - name: Checkout Envoy
        uses: actions/checkout@v4
        with:
          repository: envoyproxy/envoy
          ref: v${{ env.ENVOY_VERSION }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check system resources
        run: |
          echo "=== System Info ==="
          echo "CPUs: $(nproc)"
          echo "RAM: $(free -h | grep Mem | awk '{print $2}')"
          echo "Disk: $(df -h . | tail -1 | awk '{print $4}') available"
          echo ""
          # Verify sufficient resources
          RAM_GB=$(free -g | grep Mem | awk '{print $2}')
          CPUS=$(nproc)
          if [ "$RAM_GB" -lt 32 ]; then
            echo "ERROR: Less than 32GB RAM detected. Build will fail."
            exit 1
          fi
          if [ "$CPUS" -ge 48 ]; then
            echo "High-performance runner detected - using 48 parallel jobs"
          fi

      - name: Clean up previous builds
        run: |
          # Clean Docker to free space
          docker system prune -af --volumes || true
          # Remove old Bazel cache if exists
          rm -rf ~/.cache/bazel || true

      # Build Envoy with FIPS using official build system
      - name: Build Envoy with FIPS BoringSSL
        run: |
          # Configure for high-core-count machine (56 cores, 400GB RAM)
          # Use 48 jobs to leave headroom for system processes
          export BAZEL_BUILD_EXTRA_OPTIONS="--define boringssl=fips --jobs=48 --local_ram_resources=300000"
          export ENVOY_DOCKER_BUILD_DIR="$(pwd)/envoy-build"
          mkdir -p "$ENVOY_DOCKER_BUILD_DIR"

          # Run build in Envoy's Docker container (handles all dependencies)
          ./ci/run_envoy_docker.sh './ci/do_ci.sh bazel.release.server_only'

          # Extract binary
          mkdir -p out
          tar -xzf "$ENVOY_DOCKER_BUILD_DIR/envoy_binary.tar.gz" -C out || \
            cp "$ENVOY_DOCKER_BUILD_DIR/build_release/envoy" out/envoy
          chmod +x out/envoy

      - name: Verify FIPS build
        run: |
          echo "=== Envoy Version ==="
          ./out/envoy --version 2>&1 | tee version.txt
          if grep -qi "boringssl" version.txt; then
            echo ""
            echo "✓ Envoy built with BoringSSL FIPS"
          else
            echo ""
            echo "✗ ERROR: BoringSSL not detected - FIPS build may have failed"
            exit 1
          fi

      - name: Create proxyv2 FIPS image
        run: |
          cat > Dockerfile.proxyv2-fips << EOF
          FROM istio/proxyv2:${{ env.ISTIO_VERSION }}

          # Replace with FIPS-compiled Envoy binary
          COPY out/envoy /usr/local/bin/envoy
          EOF

      - name: Build and push proxyv2 image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.proxyv2-fips
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/proxyv2:${{ env.ISTIO_VERSION }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/proxyv2:latest

      - name: Cleanup
        if: always()
        run: |
          rm -rf envoy-build out || true
          docker system prune -f || true

  build-ztunnel:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout ztunnel
        uses: actions/checkout@v4
        with:
          repository: istio/ztunnel
          ref: ${{ env.ISTIO_VERSION }}

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ztunnel uses tls-aws-lc by default (aws-lc-rs for crypto)
      # We need to enable FIPS mode on aws-lc-rs by adding it as a direct dep with fips feature
      - name: Enable aws-lc-rs FIPS
        run: |
          # Add aws-lc-rs with FIPS feature to Cargo.toml
          cat >> Cargo.toml << 'EOF'

          # FIPS: Enable aws-lc-rs FIPS module
          [dependencies.aws-lc-rs]
          version = "1.12"
          features = ["fips"]
          EOF

          # Also add FIPS runtime check to main.rs
          sed -i '1i\
          // Verify FIPS mode at startup\
          fn verify_fips() {\
              if let Err(e) = aws_lc_rs::try_fips_mode() {\
                  eprintln!("CRITICAL: FIPS mode failed: {}", e);\
                  std::process::exit(1);\
              }\
              eprintln!("FIPS mode: ENABLED");\
          }\
          ' src/main.rs

          # Call verify_fips() at start of main
          sed -i '/^async fn main/,/^{/ { /^{/a\    verify_fips();
          }' src/main.rs || true

      - name: Build ztunnel binary (amd64)
        run: |
          rustup target add x86_64-unknown-linux-gnu
          cargo build --release --target x86_64-unknown-linux-gnu
          mkdir -p out/linux_amd64
          cp target/x86_64-unknown-linux-gnu/release/ztunnel out/linux_amd64/

      - name: Build ztunnel binary (arm64)
        run: |
          rustup target add aarch64-unknown-linux-gnu
          # Cross-compile for arm64
          sudo apt-get update && sudo apt-get install -y gcc-aarch64-linux-gnu
          export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
          cargo build --release --target aarch64-unknown-linux-gnu
          mkdir -p out/linux_arm64
          cp target/aarch64-unknown-linux-gnu/release/ztunnel out/linux_arm64/

      - name: Create Dockerfile
        run: |
          cat > Dockerfile.fips << 'EOF'
          FROM gcr.io/distroless/cc:nonroot
          ARG TARGETARCH
          COPY out/linux_${TARGETARCH}/ztunnel /usr/local/bin/ztunnel
          ENTRYPOINT ["/usr/local/bin/ztunnel"]
          EOF

      - name: Build and push ztunnel image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.fips
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/ztunnel:${{ env.ISTIO_VERSION }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/ztunnel:latest

  create-values:
    needs: [build-istiod, build-proxyv2, build-ztunnel]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: evan-hines-js/lattice

      - name: Update Istio FIPS values
        run: |
          mkdir -p charts/istio-fips
          cat > charts/istio-fips/values.yaml << 'EOF'
          # Istio FIPS Override Values
          # Use with: helm install istio-base istio/base -f values.yaml

          global:
            hub: ghcr.io/evan-hines-js/istio-fips
            tag: "${{ env.ISTIO_VERSION }}"

          pilot:
            image: pilot

          # Enforce FIPS mode at runtime
          meshConfig:
            defaultConfig:
              proxyMetadata:
                GODEBUG: "fips140=only"
          EOF

          echo "Istio FIPS values created for version ${{ env.ISTIO_VERSION }}"

      - name: Commit values
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update Istio FIPS images to ${{ env.ISTIO_VERSION }}"
          file_pattern: 'charts/istio-fips/*'
