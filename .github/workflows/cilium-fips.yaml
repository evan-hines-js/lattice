name: Build Cilium FIPS

on:
  push:
    branches: [main]
    paths:
      - '.github/workflows/cilium-fips.yaml'
  workflow_dispatch:
    inputs:
      cilium_version:
        description: 'Cilium version to build'
        required: true
        default: '1.16.5'
  schedule:
    # Rebuild weekly to pick up security patches
    - cron: '0 0 * * 0'

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: evan-hines-js/cilium-fips
  CILIUM_VERSION: ${{ github.event.inputs.cilium_version || '1.16.5' }}

jobs:
  build-cilium-agent:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Cilium
        uses: actions/checkout@v4
        with:
          repository: cilium/cilium
          ref: v${{ env.CILIUM_VERSION }}

      - name: Set up Go 1.24
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Build cilium-agent with Go 1.24 FIPS
      - name: Build cilium-agent binary
        env:
          GOFIPS140: latest
          CGO_ENABLED: 0
          GOOS: linux
        run: |
          mkdir -p out/linux_amd64 out/linux_arm64
          GOARCH=amd64 go build -o out/linux_amd64/cilium-agent ./daemon/cmd
          GOARCH=arm64 go build -o out/linux_arm64/cilium-agent ./daemon/cmd

      - name: Create Dockerfile
        run: |
          cat > Dockerfile.fips << 'EOF'
          FROM gcr.io/distroless/static:nonroot
          ARG TARGETARCH
          COPY out/linux_${TARGETARCH}/cilium-agent /usr/bin/cilium-agent
          ENV GODEBUG=fips140=only
          ENTRYPOINT ["/usr/bin/cilium-agent"]
          EOF

      - name: Build and push cilium-agent image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.fips
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/cilium:${{ env.CILIUM_VERSION }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/cilium:latest

  build-cilium-operator:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Cilium
        uses: actions/checkout@v4
        with:
          repository: cilium/cilium
          ref: v${{ env.CILIUM_VERSION }}

      - name: Set up Go 1.24
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Build cilium-operator with Go 1.24 FIPS
      - name: Build cilium-operator binary
        env:
          GOFIPS140: latest
          CGO_ENABLED: 0
          GOOS: linux
        run: |
          mkdir -p out/linux_amd64 out/linux_arm64
          GOARCH=amd64 go build -o out/linux_amd64/cilium-operator ./operator/cmd
          GOARCH=arm64 go build -o out/linux_arm64/cilium-operator ./operator/cmd

      - name: Create Dockerfile
        run: |
          cat > Dockerfile.fips << 'EOF'
          FROM gcr.io/distroless/static:nonroot
          ARG TARGETARCH
          COPY out/linux_${TARGETARCH}/cilium-operator /usr/bin/cilium-operator
          ENV GODEBUG=fips140=only
          ENTRYPOINT ["/usr/bin/cilium-operator"]
          EOF

      - name: Build and push cilium-operator image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.fips
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/operator:${{ env.CILIUM_VERSION }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/operator:latest

  build-hubble-relay:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Cilium
        uses: actions/checkout@v4
        with:
          repository: cilium/cilium
          ref: v${{ env.CILIUM_VERSION }}

      - name: Set up Go 1.24
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Build hubble-relay with Go 1.24 FIPS
      - name: Build hubble-relay binary
        env:
          GOFIPS140: latest
          CGO_ENABLED: 0
          GOOS: linux
        run: |
          mkdir -p out/linux_amd64 out/linux_arm64
          GOARCH=amd64 go build -o out/linux_amd64/hubble-relay ./hubble-relay/cmd
          GOARCH=arm64 go build -o out/linux_arm64/hubble-relay ./hubble-relay/cmd

      - name: Create Dockerfile
        run: |
          cat > Dockerfile.fips << 'EOF'
          FROM gcr.io/distroless/static:nonroot
          ARG TARGETARCH
          COPY out/linux_${TARGETARCH}/hubble-relay /usr/bin/hubble-relay
          ENV GODEBUG=fips140=only
          ENTRYPOINT ["/usr/bin/hubble-relay"]
          EOF

      - name: Build and push hubble-relay image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.fips
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/hubble-relay:${{ env.CILIUM_VERSION }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/hubble-relay:latest

  create-values:
    needs: [build-cilium-agent, build-cilium-operator, build-hubble-relay]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update Cilium FIPS values
        run: |
          mkdir -p charts/cilium-fips
          cat > charts/cilium-fips/values.yaml << 'EOF'
          # Cilium FIPS Override Values
          # Use with: helm install cilium cilium/cilium -f values.yaml

          image:
            repository: ghcr.io/evan-hines-js/cilium-fips/cilium
            tag: "${{ env.CILIUM_VERSION }}"
            useDigest: false

          operator:
            image:
              repository: ghcr.io/evan-hines-js/cilium-fips/operator
              tag: "${{ env.CILIUM_VERSION }}"
              useDigest: false

          hubble:
            relay:
              image:
                repository: ghcr.io/evan-hines-js/cilium-fips/hubble-relay
                tag: "${{ env.CILIUM_VERSION }}"
                useDigest: false

          # Cilium-specific settings for Lattice
          kubeProxyReplacement: true
          k8sServiceHost: "localhost"
          k8sServicePort: "7445"  # kube-vip

          # LB-IPAM for LoadBalancer services
          l2announcements:
            enabled: true

          externalIPs:
            enabled: true

          # eBPF-based load balancing
          loadBalancer:
            mode: dsr
            algorithm: maglev
          EOF

          echo "Cilium FIPS values created for version ${{ env.CILIUM_VERSION }}"

      - name: Commit values
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update Cilium FIPS images to ${{ env.CILIUM_VERSION }}"
          file_pattern: 'charts/cilium-fips/*'
