apiVersion: lattice.dev/v1alpha1
kind: LatticeService
metadata:
  name: secret-routes-test
  namespace: local-secrets-routes
spec:
  containers:
    main:
      image: ghcr.io/evan-hines-js/busybox:latest
      command: ["sleep", "infinity"]
      variables:
        # Route 1: Pure secret env var -> secretKeyRef
        DB_PASSWORD: "${secret.db-creds.password}"
        DB_USERNAME: "${secret.db-creds.username}"
        # Route 2: Mixed content -> ESO templated env var
        DATABASE_URL: "postgres://${secret.db-creds.username}:${secret.db-creds.password}@db.svc:5432/mydb"
        # Non-secret env var (contrast)
        APP_NAME: "secret-routes-test"
      files:
        # Route 3: File mount with secrets -> ESO ExternalSecret with template
        /etc/app/config.yaml:
          content: |
            database:
              password: ${secret.db-creds.password}
              username: ${secret.db-creds.username}
            api_key: ${secret.api-key.key}
  service:
    ports:
      http:
        port: 8080
  resources:
    db-creds:
      type: secret
      id: local-db-creds
      params:
        provider: local-test
        keys: [username, password]
        refreshInterval: 1h
    api-key:
      type: secret
      id: local-api-key
      params:
        provider: local-test
        keys: [key]
        refreshInterval: 1h
    all-db-config:
      type: secret
      id: local-database-config
      params:
        provider: local-test
        refreshInterval: 1h
    ghcr-creds:
      type: secret
      id: local-regcreds
      params:
        provider: local-test
        refreshInterval: 1h
  imagePullSecrets:
    - ghcr-creds
