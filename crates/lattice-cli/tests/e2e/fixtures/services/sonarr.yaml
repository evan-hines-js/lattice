apiVersion: lattice.dev/v1alpha1
kind: LatticeService
metadata:
  name: sonarr
  namespace: media
spec:
  workload:
    containers:
      main:
        image: docker.io/linuxserver/sonarr:latest
        security:
          apparmorProfile: Unconfined
        variables:
          PUID: "1000"
          PGID: "1000"
          TZ: "America/New_York"
        volumes:
          /config:
            source: ${resources.config}
          /downloads:
            source: ${resources.media-storage}
            path: downloads
          /tv:
            source: ${resources.media-storage}
            path: library
          /tmp: {}
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 1Gi
        readinessProbe:
          httpGet:
            path: /ping
            port: 8989
            protocol: TCP
    imagePullSecrets:
      - ghcr-creds
    resources:
      # Registry credentials for GHCR images
      ghcr-creds:
        type: secret
        id: local-regcreds
        params:
          provider: local-test
          refreshInterval: 1h
      # Owned volume (private to this service)
      config:
        type: volume
        params:
          size: 5Gi
      # Shared media storage (REFERENCE - no size)
      media-storage:
        type: volume
        id: media-storage
      # Service dependencies (bilateral agreements)
      nzbget:
        type: service
        direction: outbound
      jellyfin:
        type: service
        direction: outbound
    replicas:
      min: 1
  ingress:
    hosts:
      - sonarr.home.local
    tls:
      mode: auto
      issuerRef:
        name: letsencrypt-prod
