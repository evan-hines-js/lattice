apiVersion: lattice.dev/v1alpha1
kind: LatticeJob
metadata:
  name: data-pipeline
  namespace: batch
spec:
  queue: default
  tasks:
    master:
      replicas: 1
      workload:
        containers:
          main:
            image: ghcr.io/evan-hines-js/busybox:latest
            command: ["/bin/sh", "-c", "echo 'master ready'; sleep 30"]
            resources:
              requests:
                cpu: 100m
                memory: 64Mi
              limits:
                cpu: 200m
                memory: 128Mi
            security:
              runAsUser: 65534
              apparmorProfile: Unconfined
        resources:
          ghcr-creds:
            type: secret
            id: local-regcreds
            params:
              provider: lattice-local
              refreshInterval: 1h
      imagePullSecrets:
        - ghcr-creds
      restartPolicy: Never
    worker:
      replicas: 2
      workload:
        containers:
          main:
            image: ghcr.io/evan-hines-js/busybox:latest
            command: ["/bin/sh", "-c", "echo 'worker running'; sleep 30"]
            resources:
              requests:
                cpu: 100m
                memory: 64Mi
              limits:
                cpu: 200m
                memory: 128Mi
            security:
              runAsUser: 65534
              apparmorProfile: Unconfined
        resources:
          ghcr-creds:
            type: secret
            id: local-regcreds
            params:
              provider: lattice-local
              refreshInterval: 1h
      imagePullSecrets:
        - ghcr-creds
      restartPolicy: OnFailure
