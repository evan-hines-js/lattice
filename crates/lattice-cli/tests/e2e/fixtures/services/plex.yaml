apiVersion: lattice.dev/v1alpha1
kind: LatticeService
metadata:
  name: plex
  namespace: media
spec:
  workload:
    containers:
      main:
        image: ghcr.io/evan-hines-js/pms-docker:latest
        security:
          runAsUser: 0
          apparmorProfile: Unconfined
          allowedBinaries: ["*"]
        variables:
          TZ: "America/New_York"
        volumes:
          /config:
            source: ${resources.config}
          /media:
            source: ${resources.media-storage}
            path: library
          /tmp: {}
        resources:
          requests:
            cpu: 500m
            memory: 1Gi
          limits:
            cpu: 4000m
            memory: 8Gi
    service:
      ports:
        http:
          port: 32400
          protocol: TCP
    resources:
      # Registry credentials for GHCR images
      ghcr-creds:
        type: secret
        id: local-regcreds
        params:
          provider: lattice-local
          refreshInterval: 1h
      # Owned volume (private to this service)
      config:
        type: volume
        params:
          size: 10Gi
      # Shared media storage (UNAUTHORIZED REFERENCE - not in allowedConsumers)
      media-storage:
        type: volume
        id: media-storage
  imagePullSecrets:
    - ghcr-creds
  replicas: 1
